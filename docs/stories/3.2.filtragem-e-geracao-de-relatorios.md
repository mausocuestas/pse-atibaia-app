# Story 3.2: Filtragem e Geração de Relatórios

## Status
Draft

## Story
**As a** Gestor,
**I want** filtrar a base de dados dos alunos por múltiplos critérios,
**so that** eu possa gerar listas específicas para ações de saúde.

## Acceptance Criteria
1. Uma página de "Relatórios" permite a filtragem por múltiplos critérios.
2. Os resultados são exibidos em uma tabela paginada.
3. A tabela de resultados pode ser exportada em formato .xlsx.

## Tasks / Subtasks

### Task 1: Create Reports Page Route and Basic Structure (AC: 1)
- [ ] Create route file `app/src/routes/(protected)/gestor/relatorios/+page.svelte`
- [ ] Create server load file `app/src/routes/(protected)/gestor/relatorios/+page.server.ts`
- [ ] Add route protection to ensure only managers (`is_gestor=true`) can access
- [ ] Create basic page layout with title "Relatórios" and filter section
- [ ] Follow desktop-first responsive strategy per [Source: architecture/6-ui-implementation-patterns.md#6.3.2]

### Task 2: Design and Implement Filter Form (AC: 1)
- [ ] Create filter criteria inputs using shadcn-svelte form components:
  - School (dropdown with list from `shared.escolas`)
  - Year (number input, defaults to current year)
  - Class/Turma (text input)
  - Period (dropdown: Manhã, Tarde, Integral, Noite)
  - Evaluation Type (checkboxes: Anthropometric, Visual Acuity, Dental)
  - Health Risk/Status filters (evaluation-specific criteria)
- [ ] Implement form state management using Svelte 5 runes ($state)
- [ ] Add "Apply Filters" and "Clear Filters" buttons
- [ ] Validate inputs using Zod schema on server-side [Source: architecture/5-coding-standards.md]
- [ ] Use shadcn-svelte select, input, and checkbox components

### Task 3: Create Filtered Student Query Function (AC: 1, 2)
- [ ] Create new file `app/src/lib/server/db/queries/reports.ts`
- [ ] Implement `getFilteredStudents()` function with dynamic SQL query building
- [ ] Support multiple filter criteria:
  - School ID (escola_id)
  - Year (ano_letivo)
  - Class (turma)
  - Period
  - Evaluation types (presence in evaluation tables)
  - Health status criteria (e.g., CDC classification, visual acuity ranges, dental risk)
- [ ] Return student data with:
  - Basic student info (id, nome_completo, data_nascimento, sexo)
  - Enrollment info (escola_nome, turma, periodo)
  - Evaluation status flags (has_anthropometric, has_visual, has_dental)
  - Latest evaluation results for filtered types
- [ ] Implement pagination support (limit/offset pattern)
- [ ] Follow query patterns from [Source: app/src/lib/server/db/queries/dashboard.ts]
- [ ] Use parameterized queries to prevent SQL injection [Source: architecture/5-coding-standards.md]

### Task 4: Create Unit Tests for Reports Query (AC: 1, 2)
- [ ] Create test file `app/src/lib/server/db/queries/reports.test.ts`
- [ ] Test `getFilteredStudents()` with various filter combinations
- [ ] Test pagination logic
- [ ] Test empty results and edge cases
- [ ] Test SQL injection prevention with malicious inputs
- [ ] Follow testing patterns from [Source: app/src/lib/server/db/queries/dashboard.test.ts]
- [ ] Ensure test coverage for all filter criteria combinations

### Task 5: Implement Paginated Results Table (AC: 2)
- [ ] Use existing shadcn-svelte table components from `app/src/lib/components/ui/table`
- [ ] Display filtered student results with columns:
  - Student Name
  - Date of Birth
  - School
  - Class
  - Period
  - Evaluation Status (icons/badges for completed evaluations)
  - Latest Health Metrics (based on selected filters)
- [ ] Implement client-side pagination controls using shadcn-svelte pagination component
- [ ] Show total results count and current page info
- [ ] Handle empty state with appropriate message
- [ ] Follow desktop-first responsive grid layout [Source: architecture/6-ui-implementation-patterns.md#6.3.2]

### Task 6: Add Export to XLSX Functionality (AC: 3)
- [ ] Add `xlsx` library to `app/package.json` dependencies (selected over `exceljs` for simplicity and wide adoption)
- [ ] Create server API endpoint `app/src/routes/api/export/relatorios/+server.ts`
- [ ] Implement XLSX generation logic:
  - Include all filtered results (not just current page)
  - Add headers matching table columns
  - Format dates appropriately for Brazilian locale
  - Include filter criteria in separate sheet or header rows
- [ ] Return file as download with appropriate headers:
  - Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
  - Content-Disposition: `attachment; filename="relatorio-pse-{date}.xlsx"`
- [ ] Add "Export to Excel" button to reports page
- [ ] Show loading state during export generation
- [ ] Handle export errors with user-friendly messages

### Task 7: Create Manager Navigation Section in Sidebar
- [ ] Note: Dashboard (`/gestor/dashboard`) currently has no sidebar navigation item
- [ ] Create new "Gestor" section in sidebar with collapsible subitems:
  - Dashboard (icon: `ChartBarIcon` or `DashboardIcon` from @tabler/icons-svelte)
  - Relatórios (icon: `ReportIcon` or `FileDescriptionIcon` from @tabler/icons-svelte)
- [ ] Use existing sidebar component patterns from app-sidebar.svelte reference
- [ ] Conditionally render "Gestor" section only when `is_gestor=true` from session
- [ ] Follow NavMain or NavDocuments pattern with collapsible group
- [ ] Highlight active route when on dashboard or reports page

### Task 8: Integration Testing and Manual Verification
- [ ] Test filter combinations produce expected results
- [ ] Verify pagination works correctly with large result sets
- [ ] Test XLSX export contains accurate data matching filtered results
- [ ] Verify downloaded file opens correctly in Excel/LibreOffice
- [ ] Test responsive layout on desktop screens (21" / 1920px)
- [ ] Verify route protection denies access to non-managers
- [ ] Test with empty database and partial data scenarios
- [ ] Run TypeScript type checking: `npm run check`
- [ ] Run full test suite: `npm test`
- [ ] Build production bundle: `npm run build`

## Dev Notes

### Previous Story Insights
From Story 3.1 (Dashboard do Gestor):
- Manager role (`is_gestor`) is stored in `pse.avaliadores` table (added in migration 005)
- Manager authentication is checked via session (`locals.session.user.is_gestor`)
- Route protection pattern: Return 401 for unauthenticated, 403 for non-managers
- Dashboard queries use `ano_referencia` (year) as primary filter
- ECharts library already installed for potential future chart enhancements
- Existing query patterns use try-catch with console.error and graceful degradation (return empty arrays)
- All database queries are in `app/src/lib/server/db/queries/` directory
- Test files are co-located with same name + `.test.ts` suffix

### Data Models
[Source: architecture/seo-3-data-models-verso-30-corrigida.md]

**Aluno (Student):**
```typescript
interface Aluno {
  id: number; // Integer Primary Key
  nomeCompleto: string;
  dataNascimento: Date;
  sexo: 'Masculino' | 'Feminino';
  cpf?: string;
  nis?: string;
}
```

**Turma (Class):**
```typescript
interface Turma {
  id: number;
  anoLetivo: number;
  nome: string;
  periodo: 'Manhã' | 'Tarde' | 'Integral' | 'Noite';
  escolaId: number; // Foreign Key
}
```

**Matricula (Enrollment):**
```typescript
interface Matricula {
  id: number;
  alunoId: number; // Foreign Key to shared.clientes(id)
  turmaId: number; // Foreign Key
}
```

Note: In database implementation, students are stored in `shared.clientes` table (not `alunos`), enrollments in `pse.matriculas`, and schools in `shared.escolas`.

### Database Schema References
[Source: Inferred from existing queries in dashboard.ts, students.ts]

**Relevant Tables:**
- `shared.clientes` - Student data (id, nome_completo, data_nascimento, sexo, ativo)
- `shared.escolas` - School data (inep, escola, ativo)
- `pse.matriculas` - Enrollments (id, aluno_id, escola_id, ano_letivo, turma, periodo)
- `pse.avaliacoes_antropometricas` - Anthropometric evaluations (aluno_id, ano_referencia, peso_kg, altura_cm, classificacao_cdc)
- `pse.avaliacoes_acuidade_visual` - Visual acuity evaluations (aluno_id, ano_referencia, olho_direito, olho_esquerdo, reteste)
- `pse.avaliacoes_odontologicas` - Dental evaluations (aluno_id, ano_referencia, risco, atf_realizado, necessita_art, escovacao_orientada_realizada)
- `pse.avaliadores` - Evaluators/Managers (id, is_gestor)

**Join Patterns:**
```sql
-- Students with enrollment info
FROM pse.matriculas m
INNER JOIN shared.clientes c ON m.aluno_id = c.id
INNER JOIN shared.escolas e ON m.escola_id = e.inep

-- Students with evaluation data (LEFT JOIN for optional evaluations)
LEFT JOIN pse.avaliacoes_antropometricas aa ON aa.aluno_id = c.id AND aa.ano_referencia = m.ano_letivo
LEFT JOIN pse.avaliacoes_acuidade_visual av ON av.aluno_id = c.id AND av.ano_referencia = m.ano_letivo
LEFT JOIN pse.avaliacoes_odontologicas ao ON ao.aluno_id = c.id AND ao.ano_referencia = m.ano_letivo
```

### File Locations and Project Structure
[Source: architecture/4-unified-project-structure.md, architecture/5-coding-standards.md]

**New Files to Create:**
- `app/src/routes/(protected)/gestor/relatorios/+page.svelte` - Reports UI
- `app/src/routes/(protected)/gestor/relatorios/+page.server.ts` - Server-side data loading
- `app/src/lib/server/db/queries/reports.ts` - Reports query functions
- `app/src/lib/server/db/queries/reports.test.ts` - Reports query tests
- `app/src/routes/api/export/relatorios/+server.ts` - XLSX export API endpoint

**Files to Modify:**
- `app/package.json` - Add XLSX library dependency
- `app/src/routes/(protected)/+layout.svelte` or sidebar component - Add "Relatórios" nav link

**Existing Components to Use:**
- `app/src/lib/components/ui/table/*` - Table components (already installed)
- `app/src/lib/components/ui/data-table/*` - Advanced data table with TanStack Table (@tanstack/table-core already in package.json)
- `app/src/lib/components/ui/pagination/*` - Pagination components (already installed)
- `app/src/lib/components/ui/select/*` - Select dropdowns (already installed)
- `app/src/lib/components/ui/input/*` - Input fields (already installed)
- `app/src/lib/components/ui/checkbox/*` - Checkboxes (already installed)
- `app/src/lib/components/ui/button/*` - Buttons (already installed)
- `app/src/lib/components/ui/card/*` - Card container (already installed)

**Reference Implementation Examples Provided:**
- `app-sidebar.svelte` - Sidebar with collapsible sections, icons from @tabler/icons-svelte
- `data-table.svelte` - Full-featured data table with pagination, sorting, filtering, column visibility
- `data-table-*.svelte` - Supporting components for table cells, actions, etc.
- `nav-secondary.svelte` - Simple navigation menu pattern

**Table Implementation Options:**
1. **Simple Table**: Use basic `Table` components from `ui/table/*` for straightforward display
2. **Advanced Data Table**: Use `data-table` with TanStack Table for sorting, filtering, pagination (recommended for this story due to filtering requirements)

### API and Query Specifications
[Source: app/src/lib/server/db/queries/dashboard.ts, students.ts]

**Query Function Pattern:**
```typescript
// reports.ts
export interface FilteredStudentResult {
  aluno_id: number;
  nome_completo: string;
  data_nascimento: Date;
  sexo: string;
  escola_id: number;
  escola_nome: string;
  ano_letivo: number;
  turma: string;
  periodo: string;
  has_anthropometric: boolean;
  has_visual: boolean;
  has_dental: boolean;
  // Evaluation-specific fields (when filtered)
  classificacao_cdc?: string;
  olho_direito?: number;
  olho_esquerdo?: number;
  risco_dental?: string;
}

export interface ReportFilters {
  escolaId?: number;
  anoLetivo?: number;
  turma?: string;
  periodo?: string;
  evaluationTypes?: ('anthropometric' | 'visual' | 'dental')[];
  // Health status filters
  cdcClassification?: string[];
  visualAcuityRange?: string;
  dentalRisk?: string[];
  // Pagination
  limit?: number;
  offset?: number;
}

export async function getFilteredStudents(
  filters: ReportFilters
): Promise<{ results: FilteredStudentResult[]; total: number }> {
  // Implementation following dashboard.ts patterns
}
```

**Server Load Pattern (from dashboard +page.server.ts):**
```typescript
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ locals }) => {
  const session = await locals.auth();

  if (!session?.user) {
    return error(401, 'Unauthorized');
  }

  if (!session.user.is_gestor) {
    return error(403, 'Forbidden - Manager access required');
  }

  // Load filter options and initial results
  return {
    schools: await getSchools(),
    initialResults: await getFilteredStudents({ anoLetivo: new Date().getFullYear() })
  };
};
```

### Shadcn-Svelte Component Usage
[Source: architecture/6-ui-implementation-patterns.md#6.1, 6.2]

**Primary Reference:** https://shadcn-svelte.com/llms.txt

**Installation Command (if new components needed):**
```bash
npx shadcn-svelte@latest add [component-name] --cwd app --tailwind-css "app/src/app.pcss" --tailwind-config "app/tailwind.config.cjs" --components "app/src/lib/components/ui" --yes
```

Note: Table, data-table, pagination, select, input, checkbox, button, and card components are already installed.

### Icon Library
**Icon Source:** @tabler/icons-svelte (already installed)
- Import pattern: `import IconName from "@tabler/icons-svelte/icons/icon-name";`
- Examples used in reference code:
  - `ChartBarIcon` - For analytics/dashboard
  - `DashboardIcon` - For dashboard navigation
  - `ReportIcon` - For reports
  - `FileDescriptionIcon` - For documents
  - `SearchIcon` - For search functionality
- Browse icons: https://tabler.io/icons

### Responsive Design Strategy
[Source: architecture/6-ui-implementation-patterns.md#6.3.2]

This story implements a **Desktop-First** interface for Gestors:
- Primary design for large monitors (~21 inches / 1920px+)
- Multi-column layouts for filters and results table
- Graceful degradation: `2xl` → `xl` → `lg` → `md`
- Still functional on smaller screens, but optimized for desktop

**Example Layout:**
```svelte
<div class="grid grid-cols-3 gap-8 p-8 lg:grid-cols-2 lg:gap-6 md:grid-cols-1 md:gap-4 md:p-4">
  <!-- 3 columns on large desktop, 2 on medium, 1 on mobile -->
</div>
```

### XLSX Export Library - DECISION MADE
**Selected Library:** `xlsx` (SheetJS)
- Rationale: Most popular, battle-tested, MIT license, simpler API
- Alternative considered: `exceljs` (more feature-rich but heavier)
- Installation: `npm install xlsx @types/xlsx`

### Testing Requirements
[Source: Inferred from existing test files dashboard.test.ts, students.test.ts]

**Testing Framework:** Vitest (already configured)

**Test File Pattern:**
- Co-located with source file: `reports.ts` → `reports.test.ts`
- Use same testing patterns as dashboard.test.ts
- Mock database responses
- Test all query function variations
- Test error handling and edge cases

**Test Execution:**
- Unit tests: `npm test`
- Type checking: `npm run check`
- Build verification: `npm run build`

**Coverage Requirements:**
- All query functions tested with multiple scenarios
- Edge cases: empty results, missing data, invalid inputs
- Security: SQL injection prevention verification

### Technical Constraints
[Source: architecture/5-coding-standards.md, architecture/2-tech-stack.md]

**Coding Standards:**
- TypeScript strict mode enabled
- All server-side input validation using Zod
- Database access in `src/lib/server/db` only
- Environment variables via SvelteKit `$env` modules
- Parameterized SQL queries only (prevent SQL injection)

**Tech Stack:**
- SvelteKit 2.x (Svelte 5.x with runes)
- PostgreSQL (Neon hosted)
- shadcn-svelte for UI components
- Tailwind CSS v4 for styling
- Vitest for testing

### Security Considerations
- Manager role verification required (`is_gestor=true`)
- All queries filter by user's accessible schools (future enhancement)
- Export endpoint must validate session and manager role
- Parameterized queries prevent SQL injection
- Student data is not anonymized in this report (manager access only)

### Performance Considerations
- Pagination required for large result sets (recommend 25-50 items per page)
- Export function should handle large datasets efficiently
- Consider adding database indexes on frequently filtered columns:
  - `pse.matriculas(escola_id, ano_letivo)`
  - `pse.avaliacoes_*` tables on `(aluno_id, ano_referencia)`
- XLSX generation may take time for large exports - implement loading states

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-29 | 1.0 | Initial story creation for Epic 3 | Bob (Scrum Master) |
| 2025-10-30 | 1.1 | Updated with PO feedback: xlsx library selection confirmed, added Gestor navigation section guidance, included data-table reference examples from @tabler/icons-svelte sidebar patterns | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)
