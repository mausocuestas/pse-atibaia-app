# Story 4.1: Importação de Planilha de Matrículas

## Status
Approved

## Story
**As a** Gestor,
**I want** fazer o upload de uma planilha .xlsx com as matrículas do novo ano letivo,
**so that** o sistema seja populado com os dados mais recentes.

## Acceptance Criteria
1. Existe uma interface administrativa para o upload de arquivos .xlsx.
2. O sistema processa a planilha, identificando as colunas relevantes.
3. Novos alunos são adicionados e alunos existentes são atualizados com suas novas matrículas.
4. O sistema apresenta um relatório de sucesso da importação.

## Tasks / Subtasks

### Task 1: Create Administrative Import Interface (AC: 1)
- [ ] Create new admin route `/admin/importacao-matriculas` (requires gestor permissions)
- [ ] Create server load function with proper authentication check (is_gestor=true)
- [ ] Design file upload interface using shadcn-svelte components:
  - Card component for upload area
  - Button component for file selection
  - Progress indicator during upload
- [ ] Implement client-side file validation (.xlsx format, size limits)
- [ ] Add clear instructions and expected column format documentation
- [ ] Follow desktop-first responsive strategy [Source: architecture/6-ui-implementation-patterns.md#6.3.2]

### Task 2: Implement File Upload and Processing Server Logic (AC: 2)
- [ ] Create form action handler for file upload using SvelteKit form actions
- [ ] Implement server-side file validation and temporary storage
- [ ] Create new service file `app/src/lib/server/services/matricula-import.service.ts`:
  - Parse XLSX file using existing `xlsx` dependency [Source: package.json]
  - Identify relevant columns (nome, data_nascimento, escola, turma, periodo, etc.)
  - Validate required fields and data formats
- [ ] Implement proper error handling for malformed files
- [ ] Add file size and type validation for security
- [ ] Use parameterized queries for security [Source: architecture/5-coding-standards.md]

### Task 3: Create Database Update Logic (AC: 3)
- [ ] Create new query functions in `app/src/lib/server/db/queries/matricula-import.ts`:
  - `findOrCreateStudent(alunoData)` - Find existing student or create new one
  - `findOrCreateSchool(escolaNome)` - Find existing school or create new one
  - `findOrCreateClass(turmaData)` - Find existing class or create new one
  - `createMatricula(matriculaData)` - Create new enrollment record
- [ ] Implement transaction-based processing to ensure data consistency
- [ ] Handle duplicate student records (match by CPF/NIS/name+birth_date)
- [ ] Update existing students with new enrollment information
- [ ] Add proper logging for audit trail
- [ ] Implement batch processing for performance with large files

### Task 4: Create Import Results and Reporting Interface (AC: 4)
- [ ] Generate comprehensive import report showing:
  - Total records processed
  - New students created
  - Existing students updated
  - New schools/classes created (if any)
  - Errors encountered and row numbers
- [ ] Display results in a formatted, accessible interface
- [ ] Provide download option for error logs if needed
- [ ] Add option to retry failed records or review individual errors
- [ ] Implement success confirmation with clear next steps
- [ ] Add import history/log for administrative tracking

### Task 5: Testing and Validation (AC: 1, 2, 3, 4)
- [ ] Create unit tests for XLSX parsing logic
- [ ] Test file upload with various file formats and sizes
- [ ] Test database operations with mock data
- [ ] Test error scenarios (malformed files, missing columns, duplicate data)
- [ ] Create integration test for complete import workflow
- [ ] Test permissions and access control (only gestor can access)
- [ ] Run TypeScript type checking: `npm run check`
- [ ] Run full test suite: `npm test`

## Dev Notes

### Previous Story Insights
From Story 3.4 (Página de Dados Públicos):
- shadcn-svelte components (Card, Button, Select) fully configured and available
- Database query patterns with parameterized SQL established
- Error handling and graceful degradation patterns implemented
- Authentication and authorization patterns for manager-only routes established

From Story 3.2 (Filtragem e Geração de Relatórios):
- Table display patterns and data presentation interfaces
- Server-side data processing and validation patterns
- Pagination and data handling for large datasets

From Story 2.7 (Implementação da Persistência de Dados Local):
- Transaction patterns for database operations
- Error handling and rollback mechanisms

### Data Models
[Source: architecture/seo-3-data-models-verso-30-corrigida.md]

**Student Data Structure:**
```typescript
interface Aluno {
  id: number; // Integer Primary Key
  nomeCompleto: string;
  dataNascimento: Date;
  sexo: 'Masculino' | 'Feminino';
  cpf?: string;
  nis?: string;
}
```

**Enrollment Data Structure:**
```typescript
interface Matricula {
  id: number; // Integer Primary Key
  alunoId: number; // Foreign Key
  escolaId: number; // Foreign Key
  anoLetivo: number;
  turma: string;
  periodo: 'Manhã' | 'Tarde' | 'Integral' | 'Noite';
}
```

**Expected XLSX Columns:**
Based on existing database schema and import requirements:
- `nome_completo` or `nome` - Student full name
- `data_nascimento` or `nascimento` - Birth date (DD/MM/YYYY format)
- `sexo` - Gender (M/F or Masculino/Feminino)
- `cpf` - CPF number (optional)
- `nis` - NIS number (optional)
- `escola` or `nome_escola` - School name
- `inep` - School INEP code (if available)
- `turma` - Class name
- `periodo` - Period (Manhã/Tarde/Integral/Noite)
- `ano_letivo` - School year (e.g., 2025)

### Technical Stack
[Source: architecture/2-tech-stack.md]
- **Frontend:** SvelteKit 2.x with Svelte 5 (runes syntax)
- **File Processing:** XLSX library v0.18.5 (already installed) [Source: package.json]
- **UI Components:** shadcn-svelte (Card, Button, Progress, Table)
- **Backend:** SvelteKit server routes with form actions
- **Database:** PostgreSQL (Neon) with parameterized queries
- **Validation:** Zod schemas for data validation
- **Authentication:** Google OAuth with gestor role verification

### File Processing Capabilities
**XLSX Library Integration:**
The project already includes `xlsx: ^0.18.5` as a dependency, providing:
- Excel file parsing (.xlsx, .xls)
- CSV parsing capabilities
- Worksheet navigation and data extraction
- Data type conversion and validation

**File Upload Patterns:**
Use SvelteKit form actions for secure file handling:
```typescript
// In +page.server.ts
import { fail } from '@sveltejs/kit';

export const actions = {
  upload: async ({ request }) => {
    const formData = await request.formData();
    const file = formData.get('file') as File;

    // Validation and processing
    if (!file || file.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
      return fail(400, { error: 'Invalid file format' });
    }

    // Process file...
  }
};
```

### Project Structure
[Source: architecture/4-unified-project-structure.md]

**New Files to Create:**
- `app/src/routes/(protected)/admin/importacao-matriculas/+page.svelte` - Import interface UI
- `app/src/routes/(protected)/admin/importacao-matriculas/+page.server.ts` - Upload handling and auth
- `app/src/lib/server/services/matricula-import.service.ts` - XLSX processing logic
- `app/src/lib/server/db/queries/matricula-import.ts` - Database operations for import
- `app/src/lib/server/db/queries/matricula-import.test.ts` - Unit tests for import logic

**Files to Reference/Extend:**
- `app/src/lib/server/db/queries/students.ts` - Student query patterns
- `app/src/lib/server/db/queries/schools.ts` - School query patterns
- `app/src/lib/server/db/queries/classes.ts` - Class query patterns
- `app/src/lib/components/ui/` - Available shadcn-svelte components

**Routing Structure:**
Administrative routes follow the pattern `/admin/` under the protected group:
- `/admin/importacao-matriculas` - Only accessible to users with `is_gestor: true`

### Authentication and Authorization
**Manager-Only Access:**
This feature requires gestor-level permissions:

```typescript
// In +page.server.ts - MUST include auth check
import { redirect } from '@sveltejs/kit';
import { auth } from '$lib/server/auth';

export const load: PageServerLoad = async (event) => {
  const session = await auth.validateRequest(event);

  if (!session.user.is_gestor) {
    throw redirect(303, '/dashboard');
  }

  return {
    user: session.user
  };
};
```

**Security Pattern:**
- Verify `is_gestor: true` in user session
- Use SvelteKit form actions for secure file handling
- Validate file type and size on both client and server
- Sanitize all input data before database operations
- Implement proper error handling without information disclosure

### Database Integration Guidelines
**Transaction-Based Processing:**
For data consistency during import:

```typescript
// Transaction pattern for import operations
async function processMatriculaImport(xlsxData: any[]) {
  const transaction = await db.transaction();

  try {
    for (const row of xlsxData) {
      // Find or create student
      const aluno = await findOrCreateStudent(row, transaction);

      // Find or create school
      const escola = await findOrCreateSchool(row, transaction);

      // Create enrollment
      await createMatricula({
        alunoId: aluno.id,
        escolaId: escola.id,
        // ... other fields
      }, transaction);
    }

    await transaction.commit();
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

**Data Matching Strategy:**
- **Existing Students:** Match by CPF first, then NIS, then name+birth_date
- **Existing Schools:** Match by INEP code first, then school name
- **Existing Classes:** Match by school_id + class_name + period + year

### UI/UX Guidelines
[Source: architecture/6-ui-implementation-patterns.md]

**Administrative Interface Requirements:**
- Follow desktop-first design strategy (optimized for desktop management)
- Clear step-by-step process: Upload → Process → Review Results
- Progress indicators during file processing
- Clear error messages and guidance
- Success confirmation with detailed results

**Component Usage:**
- shadcn-svelte Card for upload area and results sections
- shadcn-svelte Button for file selection and actions
- shadcn-svelte Progress or custom progress indicator
- Table component for results display
- Alert/Notification components for feedback

**Layout Example:**
```svelte
<div class="container mx-auto p-6">
  <header class="mb-8">
    <h1>Importação de Matrículas</h1>
    <p>Processamento planilhas de matrículas do ano letivo...</p>
  </header>

  <Card class="mb-6">
    <!-- File Upload Area -->
    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
      <!-- Upload content -->
    </div>
  </Card>

  <Card class="mb-6">
    <!-- Processing Results -->
    <h2>Resultados da Importação</h2>
    <!-- Results content -->
  </Card>
</div>
```

### Error Handling Strategy
**Comprehensive Error Management:**
- **File Format Errors:** Invalid file types, corrupted files
- **Data Validation Errors:** Missing required columns, invalid data formats
- **Database Errors:** Constraint violations, connection issues
- **Business Logic Errors:** Duplicate records, invalid school/class combinations

**Error Recovery:**
- Graceful error messages that guide user to fix issues
- Option to download detailed error logs
- Retry functionality for individual failed records
- Rollback capability for failed imports

### Performance Considerations
**Large File Handling:**
- Stream-based file processing for memory efficiency
- Batch database operations (insert in chunks of 100-500 records)
- Progress reporting during long-running operations
- Timeout handling for server operations

**Database Optimization:**
- Use existing indexes on student identification fields
- Consider temporary disabling of constraints during bulk import
- Implement proper connection pooling for concurrent operations

### Security Considerations
**File Upload Security:**
- Validate file type and extension
- Limit file size to prevent DoS attacks
- Scan file content for malicious patterns
- Use secure temporary storage

**Data Protection:**
- Sanitize all input data before database operations
- Use parameterized queries to prevent SQL injection
- Implement rate limiting for import operations
- Log all import activities for audit trail

**Access Control:**
- Verify gestor permissions before allowing access
- Validate user session for each operation
- Implement CSRF protection for form submissions

## Testing

### Testing Standards
[Source: architecture/5-coding-standards.md]

**File Location:**
- Unit tests: Co-located with source files (e.g., `matricula-import.ts` → `matricula-import.test.ts`)
- Integration tests: `__tests__/` subdirectories within feature folders

**Testing Frameworks:**
- Unit Tests: Vitest (already configured)
- File Processing Tests: Mock XLSX files for testing parsing logic
- Database Tests: Transaction rollback patterns from existing tests
- UI Testing: Manual testing for file upload interface

**Test Coverage Requirements:**
- All import service functions must have unit tests
- Test file parsing with various XLSX formats and edge cases
- Test database operations with mock data and error scenarios
- Validate permission checks (only gestor can access)
- Test error handling and recovery mechanisms
- Test complete workflow integration

**Specific Testing for This Story:**
- XLSX file parsing with valid and invalid data
- Student matching logic (CPF, NIS, name+birth_date)
- School and class creation/retrieval operations
- Transaction rollback on errors
- File upload validation (type, size, content)
- Permission verification for administrative access
- Import report generation and accuracy
- Performance testing with large files (1000+ records)

**Security Testing:**
- Attempt to upload malicious files
- Verify SQL injection protection in all queries
- Test access control bypass attempts
- Validate file size and type enforcement
- Check for information disclosure in error messages

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-11-01 | 1.0 | Initial story creation for Epic 4 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be filled by Dev Agent -->

### Debug Log References
<!-- To be filled by Dev Agent -->

### Completion Notes List
<!-- To be filled by Dev Agent -->

### File List
<!-- To be filled by Dev Agent -->

## QA Results
<!-- To be filled by QA Agent -->