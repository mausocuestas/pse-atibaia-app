# Story 1.5: Implementar Layout Global com Sidebar

## Status
Draft

## Story
**As a** usuário logado,
**I want** ver uma navegação principal consistente em uma sidebar,
**so that** eu possa navegar facilmente entre as diferentes seções do sistema.

## Acceptance Criteria
1. Um novo layout para rotas protegidas `(protected)/+layout.svelte` é criado contendo a estrutura da sidebar.
2. Este layout protegido busca os dados da sessão do usuário no servidor.
3. A sidebar é exibida em todas as páginas dentro do grupo `(protected)`.
4. Para testar, a página do dashboard (`/dashboard`) deve ser movida para `/(protected)/dashboard` e deve renderizar corretamente dentro do novo layout, mesmo que esteja vazia por enquanto.

## Tasks / Subtasks

- [ ] Task 1: Research shadcn-svelte sidebar-16 example (AC: 1)
  - [ ] Visit shadcn-svelte documentation to examine sidebar-16 component
  - [ ] Identify required components (sidebar, sidebar-trigger, sidebar-content, etc.)
  - [ ] Note which components need to be installed via CLI
  - [ ] Review the code structure and responsive behavior of sidebar-16

- [ ] Task 2: Install required shadcn-svelte sidebar components (AC: 1)
  - [ ] Run `npx shadcn-svelte@latest add sidebar` to install sidebar components
  - [ ] Verify components are added to `/app/src/lib/components/ui/sidebar/`
  - [ ] Review installed component files and their dependencies
  - [ ] Ensure TypeScript types are properly generated

- [ ] Task 3: Create protected route group structure (AC: 1, 4)
  - [ ] Create new directory `/app/src/routes/(protected)/`
  - [ ] Create `(protected)/+layout.server.ts` to fetch session data
  - [ ] Create `(protected)/+layout.svelte` with sidebar structure based on sidebar-16
  - [ ] Ensure the layout includes proper TypeScript imports from `./$types`

- [ ] Task 4: Implement sidebar layout with navigation (AC: 1, 3)
  - [ ] Implement sidebar-16 structure in `(protected)/+layout.svelte`
  - [ ] Add navigation items (Dashboard as first item)
  - [ ] Include user info display in sidebar (name from session)
  - [ ] Add logout button in sidebar
  - [ ] Ensure responsive behavior (collapsible on mobile, expanded on desktop)
  - [ ] Apply proper TailwindCSS styling consistent with existing design

- [ ] Task 5: Move dashboard to protected route group (AC: 4)
  - [ ] Move `/app/src/routes/dashboard/+page.svelte` to `(protected)/dashboard/+page.svelte`
  - [ ] Move `/app/src/routes/dashboard/+page.server.ts` to `(protected)/dashboard/+page.server.ts`
  - [ ] Move `/app/src/routes/dashboard/__tests__/` to `(protected)/dashboard/__tests__/`
  - [ ] Update any import paths if necessary
  - [ ] Verify dashboard still loads correctly at `/dashboard` URL

- [ ] Task 6: Implement session data loading in protected layout (AC: 2)
  - [ ] Create `(protected)/+layout.server.ts` that loads session data
  - [ ] Return session data to the layout component
  - [ ] Add redirect logic if user is not authenticated (redirect to `/`)
  - [ ] Ensure TypeScript types are correct for LayoutServerLoad

- [ ] Task 7: Update root layout to remove conditional header (AC: 3)
  - [ ] Remove the conditional header from `/app/src/routes/+layout.svelte`
  - [ ] Keep only the app.css import and children render
  - [ ] Ensure login page still renders correctly without header
  - [ ] Verify favicon and head elements remain

- [ ] Task 8: Test navigation and routing (AC: 1-4)
  - [ ] Verify unauthenticated users are redirected from `/dashboard` to `/`
  - [ ] Verify authenticated users see sidebar when accessing `/dashboard`
  - [ ] Test sidebar toggle functionality on mobile and desktop
  - [ ] Verify navigation items work correctly
  - [ ] Test logout button functionality from sidebar
  - [ ] Verify user info displays correctly in sidebar
  - [ ] Test responsive behavior at different breakpoints

## Dev Notes

### Previous Story Insights (Story 1.4)

Story 1.4 successfully implemented:
- Professional login page with shadcn-svelte components (Card, Button, Input, Field)
- TailwindCSS v4.1 styling with responsive design
- Official branding with logoPEA.png and imagem-login.png
- Google OAuth authentication flow working correctly
- Type-safe component architecture with TypeScript strict mode

**Key Learnings:**
- Shadcn-svelte components install via CLI (`npx shadcn-svelte@latest add <component>`)
- Temporary `tailwind.config.cjs` needed for shadcn-svelte CLI compatibility with Tailwind v4
- Components are added to `/app/src/lib/components/ui/<component>/`
- Type safety with `./$types` imports from SvelteKit is critical
- Auth.js session handling works via `data.session` from `+page.server.ts`

[Source: docs/stories/1.4.refatoracao-da-ui-de-login.md]

### Current Project State

**Current Layout Structure:**
- Root layout at `/app/src/routes/+layout.svelte` has conditional header for authenticated users
- Header shows user name and logout button
- Dashboard exists at `/app/src/routes/dashboard/`
- Dashboard has its own `+page.server.ts` that loads session data

**What Needs to Change:**
- Create new `(protected)` route group with its own layout
- Move dashboard into the protected route group
- Implement sidebar navigation in the protected layout
- Remove conditional header from root layout (sidebar will replace it)

[Source: Current implementation review]

### SvelteKit Route Groups

**Route Groups in SvelteKit:**
Route groups allow you to organize routes and apply shared layouts without affecting the URL structure. A route group is created using parentheses in the folder name: `(groupname)`.

**Example:**
```
routes/
├── (protected)/
│   ├── +layout.svelte          # Applies to all routes in this group
│   ├── +layout.server.ts       # Server-side data loading for layout
│   ├── dashboard/
│   │   └── +page.svelte        # URL: /dashboard (not /protected/dashboard)
│   └── settings/
│       └── +page.svelte        # URL: /settings (not /protected/settings)
```

**Key Points:**
- The `(protected)` folder name does NOT appear in URLs
- `/dashboard` still works as `/dashboard` (not `/protected/dashboard`)
- The layout in `(protected)/+layout.svelte` wraps all child routes
- Session protection logic goes in `(protected)/+layout.server.ts`

[Source: SvelteKit documentation - Layouts and route groups]

### Shadcn-svelte Sidebar-16 Example

**Sidebar-16 Structure:**
The sidebar-16 example from shadcn-svelte provides a comprehensive sidebar layout with:
- Collapsible/expandable sidebar
- Navigation items with icons
- User profile section
- Responsive behavior (drawer on mobile, sidebar on desktop)
- Proper state management for open/closed state

**Required Components:**
Based on shadcn-svelte patterns, the sidebar typically uses:
- `Sidebar` - Main container component
- `SidebarTrigger` - Button to toggle sidebar
- `SidebarContent` - Content area for navigation items
- `SidebarHeader` - Header section (usually logo/branding)
- `SidebarFooter` - Footer section (usually user info)
- `SidebarMenu`, `SidebarMenuItem` - Navigation menu components

**Installation:**
```bash
npx shadcn-svelte@latest add sidebar
```

**Reference:**
Visit https://www.shadcn-svelte.com/docs/components/sidebar for latest implementation details and sidebar-16 example code.

[Source: Shadcn-svelte documentation]

### Authentication and Session Handling

**Current Auth Implementation (from Story 1.3):**
- Auth.js with Google OAuth configured
- Session data loaded in `+layout.server.ts` at root level
- Session includes: `user.name`, `user.email`, `user.image`
- Custom field: `nome_profissional` from `avaliadores` table

**Protected Layout Server Load:**
```typescript
// (protected)/+layout.server.ts
import { redirect } from '@sveltejs/kit';
import type { LayoutServerLoad } from './$types';

export const load: LayoutServerLoad = async (event) => {
  const session = await event.locals.auth();

  if (!session?.user) {
    throw redirect(302, '/');
  }

  return {
    session
  };
};
```

**Key Points:**
- Use `event.locals.auth()` to get session in server load functions
- Redirect unauthenticated users to login page (`/`)
- Return session data to layout for use in sidebar
- TypeScript types from `./$types` ensure type safety

[Source: docs/stories/1.3.autenticacao-de-usuario-com-google-oauth.md + Auth.js documentation]

### Navigation Structure

**Initial Navigation Items:**
For this story, we'll implement a minimal navigation structure:
1. **Dashboard** - Link to `/dashboard` (Home icon)
2. **Logout** - Logout button in sidebar footer

**Future Navigation Items (placeholder for later stories):**
- Avaliar Alunos (clipboard icon)
- Relatórios (chart icon)
- Configurações (settings icon)

**User Info Display:**
- Show user's `nome_profissional` (if available) or `name` from session
- Show user's email
- Optional: Show user avatar/profile image

[Source: PRD requirements and current session data structure]

### Sidebar Responsive Behavior

**Mobile (< 768px):**
- Sidebar hidden by default
- Sidebar trigger button visible in header/top bar
- Sidebar opens as drawer/overlay when triggered
- Overlay closes when clicking outside or on navigation item

**Desktop (≥ 768px):**
- Sidebar visible by default
- Can be collapsed to icon-only mode
- Toggle button allows expanding/collapsing
- State persists during navigation

**Implementation Pattern:**
```svelte
<script lang="ts">
  import { Sidebar, SidebarTrigger } from '$lib/components/ui/sidebar';
  let sidebarOpen = $state(true); // Desktop default
</script>

<!-- Mobile trigger in top bar -->
<header class="md:hidden">
  <SidebarTrigger bind:open={sidebarOpen} />
</header>

<!-- Sidebar component with responsive behavior -->
<Sidebar bind:open={sidebarOpen} class="hidden md:block">
  <!-- Sidebar content -->
</Sidebar>
```

[Source: Shadcn-svelte responsive patterns]

### Project Structure & File Locations

**New Files to Create:**
```
app/src/routes/
├── (protected)/
│   ├── +layout.server.ts                # NEW: Session loading + auth guard
│   ├── +layout.svelte                   # NEW: Sidebar layout structure
│   └── dashboard/
│       ├── +page.svelte                 # MOVED from /dashboard/+page.svelte
│       ├── +page.server.ts              # MOVED from /dashboard/+page.server.ts
│       └── __tests__/                   # MOVED from /dashboard/__tests__/
│           └── +page.server.test.ts
```

**Files to Modify:**
```
app/src/routes/
└── +layout.svelte                       # MODIFY: Remove conditional header
```

**New UI Components (installed via CLI):**
```
app/src/lib/components/ui/
└── sidebar/                             # NEW: Installed via shadcn-svelte CLI
    ├── sidebar.svelte
    ├── sidebar-trigger.svelte
    ├── sidebar-content.svelte
    ├── sidebar-header.svelte
    ├── sidebar-footer.svelte
    ├── sidebar-menu.svelte
    └── index.ts
```

[Source: docs/architecture/4-unified-project-structure.md]

### Coding Standards Compliance

**TypeScript:**
- Maintain strict mode compliance (`tsconfig.json` has `strict: true`)
- Import types from `./$types` for SvelteKit type safety
- Type all component props and layout data
- Use proper type annotations for session data

**Component Structure:**
- Use `<script lang="ts">` for TypeScript support
- Use Svelte 5 runes syntax: `$state`, `$props`, `$derived`
- Keep components modular and reusable
- Import UI components from `$lib/components/ui/`

**Validation:**
- No new user input validation needed (navigation only)
- Session validation handled by Auth.js
- Ensure session exists before rendering protected content

**Server Load Functions:**
- Use `LayoutServerLoad` type from `./$types`
- Handle authentication checks in `+layout.server.ts`
- Use `throw redirect()` for auth failures
- Return minimal data needed for layout

[Source: docs/architecture/5-coding-standards.md]

### Layout Component Best Practices

**Sidebar Layout Pattern:**
```svelte
<!-- (protected)/+layout.svelte -->
<script lang="ts">
  import { Sidebar, SidebarTrigger, SidebarContent } from '$lib/components/ui/sidebar';
  import type { LayoutData } from './$types';

  let { data, children }: { data: LayoutData; children: any } = $props();
  let sidebarOpen = $state(true);
</script>

<div class="flex h-screen">
  <!-- Sidebar -->
  <Sidebar bind:open={sidebarOpen}>
    <SidebarContent>
      <!-- Navigation items -->
    </SidebarContent>
  </Sidebar>

  <!-- Main content area -->
  <main class="flex-1 overflow-y-auto">
    <header class="md:hidden">
      <SidebarTrigger bind:open={sidebarOpen} />
    </header>
    {@render children?.()}
  </main>
</div>
```

**Key Patterns:**
- Use flexbox for sidebar + content layout
- Sidebar has fixed width, main content is `flex-1`
- Main content has `overflow-y-auto` for scrolling
- Mobile trigger only visible on small screens (`md:hidden`)
- Children rendered inside main content area

[Source: Shadcn-svelte layout patterns]

### Migration Strategy

**Step-by-Step Migration:**
1. Install sidebar components via CLI
2. Create `(protected)` folder structure
3. Create protected layout files (server + client)
4. Move dashboard files to protected group
5. Update root layout to remove header
6. Test authentication flow
7. Test navigation and routing

**Risk Mitigation:**
- Keep original dashboard files until migration is verified
- Test auth flow thoroughly after migration
- Verify URLs still work correctly (`/dashboard` not `/protected/dashboard`)
- Ensure tests still pass after moving files

**Rollback Plan:**
If issues arise, can revert by:
1. Moving dashboard files back to original location
2. Restoring conditional header in root layout
3. Deleting `(protected)` folder

[Source: Best practices for SvelteKit route restructuring]

### Testing

**Testing Requirements:**

This story focuses on layout restructuring and navigation implementation. Testing should verify:

1. **Authentication Flow:**
   - Unauthenticated users redirected from `/dashboard` to `/`
   - Authenticated users can access `/dashboard` with sidebar
   - Session data loads correctly in protected layout

2. **Navigation Testing:**
   - Dashboard link navigates to `/dashboard`
   - Logout button triggers signOut and redirects to `/`
   - URL structure remains clean (no `/protected/` in URLs)

3. **Responsive Testing:**
   - Mobile: Sidebar hidden by default, toggle button visible
   - Desktop: Sidebar visible by default, can be collapsed
   - Sidebar state persists during page navigation

4. **Layout Rendering:**
   - Sidebar displays user info correctly
   - Navigation items render with proper styling
   - Main content area renders children correctly
   - No layout shift or visual glitches

**Testing Approach:**
- **Manual Testing:** Primary method for this UI-focused story
- **Existing Tests:** Verify dashboard tests still pass after file move
- **No New Automated Tests:** Not required for this story scope

**Manual Testing Checklist:**
- [ ] Unauthenticated access to `/dashboard` redirects to `/`
- [ ] Authenticated users see sidebar at `/dashboard`
- [ ] Sidebar toggle works on mobile (< 768px)
- [ ] Sidebar collapse/expand works on desktop (≥ 768px)
- [ ] Dashboard link in sidebar navigates correctly
- [ ] Logout button works from sidebar
- [ ] User name displays correctly in sidebar
- [ ] Layout is responsive and clean at all breakpoints
- [ ] Login page unaffected (no sidebar, no header)
- [ ] Existing dashboard tests pass after migration

**Note on Test Migration:**
When moving dashboard files, also move the `__tests__` directory. Update any import paths if necessary. Run tests after migration to ensure no breakage:
```bash
npm run test
```

[Source: docs/architecture/testing-strategy.md (inferred from Story 1.4 patterns)]

### Known Limitations & Future Work

**Current Story Scope:**
- Basic sidebar with minimal navigation (Dashboard only)
- Simple user info display (name and logout)
- Foundation for future navigation expansion

**Future Stories:**
- Add more navigation items as features are implemented
- Implement user profile settings page
- Add notifications or alerts in sidebar
- Implement breadcrumb navigation in main content area
- Add sidebar state persistence (localStorage)
- Implement search functionality in sidebar

**Out of Scope:**
- Complex navigation menu with sub-items (not needed yet)
- User avatar/profile image upload
- Dark mode toggle (future enhancement)
- Sidebar customization options

### Reference Materials

**External Resources:**
- [Shadcn-svelte Sidebar Components](https://www.shadcn-svelte.com/docs/components/sidebar)
- [SvelteKit Routing - Route Groups](https://kit.svelte.dev/docs/advanced-routing#advanced-layouts-group)
- [SvelteKit Layouts](https://kit.svelte.dev/docs/routing#layout)
- [Auth.js Session Management](https://authjs.dev/getting-started/session-management)

**Internal Resources:**
- Story 1.3: Authentication implementation and session handling
- Story 1.4: UI components and responsive design patterns
- Architecture: Coding standards and project structure
- PRD Epic 1: Original layout and protected routes requirements

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-23 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent during implementation_

### Debug Log References
_To be filled by Dev Agent during implementation_

### Completion Notes List
_To be filled by Dev Agent during implementation_

### File List
_To be filled by Dev Agent during implementation_

## QA Results
_To be filled by QA Agent after implementation_
